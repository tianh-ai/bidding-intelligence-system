#!/bin/bash
#
# çŸ¥è¯†åº“æ˜¾ç¤ºé—®é¢˜ä¸€é”®ä¿®å¤è„šæœ¬
# éµå¾ª Docker ä½¿ç”¨åŽŸåˆ™
#

set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ”§ çŸ¥è¯†åº“æ˜¾ç¤ºé—®é¢˜ä¸€é”®ä¿®å¤"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
echo "ðŸ“‹ 1. æ£€æŸ¥DockerçŽ¯å¢ƒ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if ! command -v docker &> /dev/null; then
    echo "âŒ Dockeræœªå®‰è£…ï¼è¯·å…ˆå®‰è£…Docker Desktop"
    exit 1
fi

if ! docker info &> /dev/null; then
    echo "âŒ Dockeræœªè¿è¡Œï¼è¯·å¯åŠ¨Docker Desktop"
    exit 1
fi

echo "âœ… DockerçŽ¯å¢ƒæ­£å¸¸"
echo ""

# 2. æ£€æŸ¥å‰ç«¯é…ç½®
echo "ðŸ“‹ 2. æ£€æŸ¥å‰ç«¯é…ç½®"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

if [ ! -f "frontend/.env" ]; then
    echo "âš ï¸  frontend/.env ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»º..."
    cat > frontend/.env << EOF
# API é…ç½®
VITE_API_URL=http://localhost:18888

# é»˜è®¤ç®¡ç†å‘˜è´¦å·
VITE_DEFAULT_ADMIN_USERNAME=admin
VITE_DEFAULT_ADMIN_PASSWORD=bidding2024
EOF
    echo "âœ… å·²åˆ›å»º frontend/.env"
else
    # æ£€æŸ¥API_URLé…ç½®
    if grep -q "VITE_API_URL=http://localhost:18888" frontend/.env; then
        echo "âœ… å‰ç«¯APIåœ°å€é…ç½®æ­£ç¡®"
    else
        echo "âš ï¸  å‰ç«¯APIåœ°å€é…ç½®é”™è¯¯ï¼Œæ­£åœ¨ä¿®å¤..."
        sed -i.bak 's|VITE_API_URL=.*|VITE_API_URL=http://localhost:18888|' frontend/.env
        echo "âœ… å·²ä¿®å¤ä¸º http://localhost:18888"
    fi
fi
echo ""

# 3. åœæ­¢çŽ°æœ‰æœåŠ¡
echo "ðŸ“‹ 3. åœæ­¢çŽ°æœ‰DockeræœåŠ¡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

docker-compose down
echo "âœ… å·²åœæ­¢æ‰€æœ‰æœåŠ¡"
echo ""

# 4. é‡æ–°æž„å»ºåŽç«¯ï¼ˆåŒ…å«æœ€æ–°ä»£ç ï¼‰
echo "ðŸ“‹ 4. é‡æ–°æž„å»ºåŽç«¯é•œåƒ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "   è¿™å°†åŒ…å«æœ€æ–°çš„ knowledge.py è·¯ç”±..."
echo ""

docker-compose build backend

echo "âœ… åŽç«¯é•œåƒæž„å»ºå®Œæˆ"
echo ""

# 5. å¯åŠ¨æ‰€æœ‰æœåŠ¡
echo "ðŸ“‹ 5. å¯åŠ¨æ‰€æœ‰DockeræœåŠ¡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

docker-compose up -d

echo "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
echo ""

# 6. ç­‰å¾…æœåŠ¡å°±ç»ª
echo "ðŸ“‹ 6. ç­‰å¾…æœåŠ¡å¯åŠ¨..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

sleep 5

# 7. éªŒè¯æœåŠ¡çŠ¶æ€
echo "ðŸ“‹ 7. éªŒè¯æœåŠ¡çŠ¶æ€"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

docker-compose ps

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“‹ 8. æµ‹è¯•åŽç«¯API"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "8.1 æµ‹è¯•æ ¹è·¯å¾„"
if curl -s http://localhost:18888/ | grep -q "æ ‡ä¹¦æ™ºèƒ½ç³»ç»Ÿ"; then
    echo "âœ… åŽç«¯æ ¹è·¯å¾„æ­£å¸¸"
else
    echo "âš ï¸  åŽç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç¨åŽé‡è¯•"
fi

echo ""
echo "8.2 æµ‹è¯•çŸ¥è¯†åº“è·¯ç”±"
# å…ˆç™»å½•èŽ·å–token
TOKEN=$(curl -s -X POST http://localhost:18888/api/auth/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"admin","password":"bidding2024"}' \
  | grep -o '"token":"[^"]*' | cut -d'"' -f4)

if [ -n "$TOKEN" ]; then
    echo "âœ… ç™»å½•æˆåŠŸ"
    
    # æµ‹è¯•çŸ¥è¯†åº“API
    if curl -s -H "Authorization: Bearer $TOKEN" \
        http://localhost:18888/api/knowledge/statistics \
        | grep -q "total"; then
        echo "âœ… çŸ¥è¯†åº“APIæ­£å¸¸"
    else
        echo "âš ï¸  çŸ¥è¯†åº“APIå¯èƒ½è¿˜åœ¨åˆå§‹åŒ–"
    fi
else
    echo "âš ï¸  ç™»å½•å¤±è´¥ï¼ŒåŽç«¯å¯èƒ½è¿˜åœ¨å¯åŠ¨"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ä¿®å¤å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ðŸŽ¯ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
echo ""
echo "  1. æ‰“å¼€æµè§ˆå™¨è®¿é—®å‰ç«¯"
echo "     URL: http://localhost:5173"
echo ""
echo "  2. ç™»å½•ç³»ç»Ÿ"
echo "     ç”¨æˆ·å: admin"
echo "     å¯†ç : bidding2024"
echo ""
echo "  3. ä¸Šä¼ ä¸€ä¸ªPDFæ–‡ä»¶"
echo ""
echo "  4. ç­‰å¾…æ–‡ä»¶çŠ¶æ€å˜ä¸º 'completed'"
echo ""
echo "  5. æŸ¥çœ‹ 'çŸ¥è¯†åº“æ¡ç›®' Tab"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“ æœ‰ç”¨çš„å‘½ä»¤ï¼š"
echo ""
echo "  æŸ¥çœ‹åŽç«¯æ—¥å¿—:"
echo "    docker-compose logs -f backend"
echo ""
echo "  æŸ¥çœ‹æ‰€æœ‰æœåŠ¡çŠ¶æ€:"
echo "    docker-compose ps"
echo ""
echo "  é‡å¯åŽç«¯:"
echo "    docker-compose restart backend"
echo ""
echo "  å®Œæ•´æµ‹è¯•:"
echo "    python test_port_18888.py"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âš ï¸  é‡è¦æé†’ï¼š"
echo "   - æ‰€æœ‰æœåŠ¡å¿…é¡»é€šè¿‡ Docker è¿è¡Œ"
echo "   - å‰ç«¯è®¿é—®åŽç«¯å¿…é¡»ä½¿ç”¨ç«¯å£ 18888"
echo "   - è¯¦è§: DOCKER_PRINCIPLES.md"
echo ""
