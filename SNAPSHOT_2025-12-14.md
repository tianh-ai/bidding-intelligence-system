# ä»£ç å¿«ç…§ï¼ˆå·²éªŒè¯å·¥ä½œæ­£å¸¸ï¼‰

æ—¥æœŸï¼š2025-12-14

æœ¬æ–‡ä»¶ç”¨äºâ€œä¿å­˜å¥½ç°åœ¨çš„ä»£ç â€ï¼šæ˜ç¡®å½“å‰æ­£ç¡®çš„è¿è¡Œæ–¹å¼ã€ç«¯å£ã€å…³é”®é“¾è·¯ï¼ˆå¿…é¡» MCP + Ollamaï¼‰ï¼Œä»¥åŠå›æ»š/å¤éªŒæ–¹æ³•ï¼Œé¿å…åç»­è¢«é”™è¯¯è„šæœ¬/æ–‡æ¡£è¯¯å¯¼ã€‚

## âœ… å”¯ä¸€æ­£ç¡®çš„è¿è¡Œæ–¹å¼ï¼ˆå¼ºåˆ¶ï¼‰

- å¿…é¡» Dockerï¼š`docker compose up -d`
- åç«¯å¯¹å¤–ç«¯å£ï¼š`18888`ï¼ˆå®¹å™¨å†… 8000ï¼‰
- å‰ç«¯å¯¹å¤–ç«¯å£ï¼š`13000`ï¼ˆå®¹å™¨å†… 5173ï¼‰

è®¿é—®ï¼š
- å‰ç«¯ï¼š`http://localhost:13000`
- åç«¯å¥åº·ï¼š`http://localhost:18888/health`

## ğŸ”’ æ ¸å¿ƒçº¦æŸï¼ˆä¸å¯ç ´åï¼‰

- çŸ¥è¯†åº“é“¾è·¯å¿…é¡»èµ° MCPï¼ˆFastAPI â†’ MCP Client â†’ MCP Server â†’ Python Backend â†’ DBï¼‰
- embeddings å¿…é¡»èµ° Ollamaï¼ˆDocker å†…é€šè¿‡ `http://host.docker.internal:11434` è®¿é—®å®¿ä¸» Ollamaï¼‰

## ğŸ§  å‰ç«¯å±•ç¤ºï¼ˆæœ¬æ¬¡ä¿®å¤æˆæœï¼‰

- `/summary`ï¼ˆ`frontend/src/pages/FileSummary.tsx`ï¼‰ï¼š
  - æ”¯æŒå¤šæ¡/åˆ†é¡µ
  - æ”¯æŒå±•å¼€è¯¦æƒ…ï¼ˆå…¨æ–‡ + metadataï¼‰ï¼Œè¯¦æƒ…èµ° `GET /api/knowledge/entries/{id}`

- ä¸Šä¼ é¡µï¼ˆ`frontend/src/pages/FileUpload.tsx`ï¼Œå—ä¿æŠ¤æ–‡ä»¶ï¼‰ï¼š
  - å³ä¾§â€œçŸ¥è¯†æ¡ç›®â€æ”¯æŒç‚¹å‡»â€œæŸ¥çœ‹â€å¼¹çª—
  - è¯¦æƒ…èµ° `GET /api/knowledge/entries/{id}`

> è¯´æ˜ï¼šåˆ—è¡¨é€šå¸¸åªè¿”å› `content_preview`ï¼Œå…¨æ–‡å¿…é¡»èµ°è¯¦æƒ…æ¥å£ã€‚

## ğŸ”Œ MCP æœåŠ¡å™¨ï¼ˆçŸ¥è¯†åº“ï¼‰

ç›®å½•ï¼š`mcp-servers/knowledge-base/`

- TypeScript MCP Serverï¼š`mcp-servers/knowledge-base/src/index.ts`ï¼ˆæ„å»ºäº§ç‰© `dist/index.js`ï¼‰
- Python Backendï¼š`mcp-servers/knowledge-base/python/knowledge_base.py`

## âœ… å¦‚ä½•è¯æ˜â€œèµ°äº† MCP + ç”¨äº† Ollamaâ€

### 1) æœåŠ¡åœ¨çº¿
```bash
curl -s http://localhost:18888/health
curl -s http://localhost:18888/api/knowledge/health
```

### 2) è§¦å‘ Ollama embeddingsï¼ˆè¯­ä¹‰æœç´¢æˆ–é‡å»ºç´¢å¼•ï¼‰
```bash
# è¯­ä¹‰æœç´¢ï¼ˆä¼šè§¦å‘ embeddingsï¼‰
curl -s -X POST http://localhost:18888/api/knowledge/search/semantic \
  -H 'Content-Type: application/json' \
  -d '{"query":"æµ‹è¯•","limit":3,"min_similarity":0.6}'

# æˆ–ï¼šé‡å»ºç´¢å¼•ï¼ˆä¼šæ‰¹é‡è§¦å‘ embeddingsï¼‰
curl -s -X POST http://localhost:18888/api/knowledge/reindex
```

### 3) ä»åç«¯æ—¥å¿—è§‚å¯Ÿ MCP/Ollama çº¿ç´¢
```bash
docker compose logs -f backend
```

## ğŸ§ª å¿«é€Ÿå¤éªŒè„šæœ¬ï¼ˆæ¨èï¼‰

- ä¸€é”®ç³»ç»Ÿæ ¡éªŒï¼š`scripts/quick_verify.sh`
- MCP çŸ¥è¯†åº“è‡ªæ£€ï¼ˆDocker/HTTPï¼‰ï¼š`run_knowledge_test.sh`
- MCP server è‡ªæ£€ï¼š`mcp-servers/knowledge-base/quick_verify.sh`

## ğŸ›¡ï¸ å—ä¿æŠ¤æ–‡ä»¶ï¼ˆä¸è¦éšæ„æ”¹ï¼‰

- `frontend/src/pages/FileUpload.tsx`
- `frontend/src/services/api.ts`
- `backend/routers/files.py`
- `backend/agents/preprocessor.py`
- `backend/engines/smart_router.py`

å¯å®‰è£…æäº¤ä¿æŠ¤ï¼š
```bash
cp scripts/pre-commit-protection.sh .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

## ğŸ’¾ ä¿å­˜/å›æ»šæ–¹å¼ï¼ˆå»ºè®®ï¼‰

### æ–¹å¼ Aï¼šæäº¤ + æ‰“ tagï¼ˆæ¨èï¼‰
```bash
git status
# ç¡®è®¤æ— è¯¯åæäº¤
git add -A
git commit -m "snapshot: mcp knowledge + frontend details + docker ports"

# æ‰“æ ‡ç­¾ï¼ˆå¿«ç…§ï¼‰
git tag snapshot-2025-12-14
```

å›æ»šï¼š
```bash
git checkout snapshot-2025-12-14
```

### æ–¹å¼ Bï¼šç”Ÿæˆè¡¥ä¸æ–‡ä»¶
```bash
git diff > snapshot-2025-12-14.patch
```

åº”ç”¨è¡¥ä¸ï¼š
```bash
git apply snapshot-2025-12-14.patch
```

## âš ï¸ å·²çŸ¥æœªå®Œç»“é—®é¢˜ï¼ˆå½’æ¡£ï¼‰

- DOCX ç›®å½•è§£æä¸ä¸€è‡´ï¼ˆç¼ºå¤±â€œç¬¬äºŒéƒ¨åˆ†/ç¬¬Xéƒ¨åˆ†â€ï¼‰ï¼š
  - å½’æ¡£ï¼š`reports/unresolved/2025-12-14_toc_inconsistency_docx_part_title_missing/README.md`
