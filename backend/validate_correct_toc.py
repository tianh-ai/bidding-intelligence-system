"""
验证解析结果与用户提供的正确目录是否匹配
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from engines.parse_engine import ParseEngine
import re

# 用户提供的正确目录
CORRECT_TOC = """
第一部分合同协议书...............................................................1
一、工程概况..................................................................1
二、合同工期..................................................................1
三、质量标准..................................................................2
四、签约合同价与合同价格形式..................................................2
五、项目经理..................................................................2
六、合同文件构成..............................................................2
七、承诺......................................................................3
八、词语含义..................................................................3
九、签订时间..................................................................3
十、签订地点..................................................................3
十一、补充协议................................................................3
十二、合同生效................................................................3
十三、合同份数................................................................3
第二部分通用合同条款.............................................................5
1.一般约定...................................................................5
2.发包人....................................................................11
3.承包人....................................................................13
4.监理人....................................................................16
5.工程质量..................................................................18
6.安全文明施工与环境保护....................................................19
7.工期和进度................................................................22
8.材料与设备................................................................26
9.试验与检验................................................................29
10.变更.....................................................................30
11.价格调整.................................................................34
12.合同价格、计量与支付.....................................................36
13.验收和工程试车...........................................................39
14.竣工结算.................................................................43
15.缺陷责任与保修...........................................................44
16.违约.....................................................................47
17.不可抗力.................................................................49
18.保险.....................................................................51
19.索赔.....................................................................52
20.争议解决.................................................................53
第三部分专用合同条款............................................................55
1.一般约定..................................................................55
2.发包人....................................................................58
3.承包人....................................................................58
4.监理人....................................................................60
5.工程质量..................................................................61
6.安全文明施工与环境保护....................................................61
7.工期和进度................................................................62
8.材料与设备................................................................63
9.试验与检验................................................................64
10.变更.....................................................................64
11.价格调整.................................................................65
12.合同价格、计量与支付.....................................................66
13.验收和工程试车...........................................................69
14.竣工结算.................................................................70
15.缺陷责任期与保修.........................................................71
16.违约.....................................................................72
17.不可抗力.................................................................73
18.保险.....................................................................74
20.争议解决.................................................................74
21.甲乙双方的权利和义务......................................................74
附件1：承包人承揽工程项目一览表..................................................79
附件2：发包人供应材料设备一览表..................................................80
附件3：工程质量保修书............................................................81
附件4：主要建设工程文件目录......................................................83
附件5：承包人用于本工程施工的机械设备表..........................................84
附件6：承包人主要施工管理人员表..................................................85
附件7：分包人主要施工管理人员表..................................................86
附件8：履约担保..................................................................87
附件9：预付款担保...............................................................88
附件10:支付担保................................................................89
附件11：.........................................................................92
11-1：材料暂估价表...........................................................92
11-2：工程设备暂估价表.......................................................92
11-3：专业工程暂估价表.......................................................94
12：工程款支付申请表.............................................................95
13：代理人授权委托书.............................................................96
"""

def parse_correct_toc():
    """解析正确目录为结构化数据"""
    lines = [l.strip() for l in CORRECT_TOC.strip().split('\n') if l.strip()]
    toc_items = []
    
    for line in lines:
        # 去除点号和页码
        cleaned = re.sub(r'\.+\d+$', '', line).strip()
        
        # 识别编号和标题
        # 第X部分
        m = re.match(r'^(第[一二三四五]部分)(.+)', cleaned)
        if m:
            toc_items.append({
                'number': m.group(1),
                'title': m.group(2),
                'level': 1,
                'original': line
            })
            continue
        
        # 中文编号：一、二、...十三、
        m = re.match(r'^([一二三四五六七八九十]+)、(.+)', cleaned)
        if m:
            toc_items.append({
                'number': m.group(1),
                'title': m.group(2),
                'level': 2,
                'original': line
            })
            continue
        
        # 阿拉伯数字编号：1. 2. ...21.
        m = re.match(r'^(\d+)\.(.+)', cleaned)
        if m:
            toc_items.append({
                'number': m.group(1),
                'title': m.group(2),
                'level': 2,
                'original': line
            })
            continue
        
        # 附件编号
        m = re.match(r'^(附件\d+)[：:](.+)', cleaned)
        if m:
            toc_items.append({
                'number': m.group(1),
                'title': m.group(2),
                'level': 2,
                'original': line
            })
            continue
        
        # 附件子项：11-1、11-2
        m = re.match(r'^(\d+-\d+)[：:](.+)', cleaned)
        if m:
            toc_items.append({
                'number': m.group(1),
                'title': m.group(2),
                'level': 3,
                'original': line
            })
            continue
        
        # 纯数字编号（12、13）
        m = re.match(r'^(\d+)[：:](.+)', cleaned)
        if m:
            toc_items.append({
                'number': m.group(1),
                'title': m.group(2),
                'level': 2,
                'original': line
            })
            continue
    
    return toc_items

def validate_parsing():
    """验证当前解析结果"""
    print("=" * 80)
    print("目录解析验证")
    print("=" * 80)
    
    # 1. 解析正确目录
    correct_toc = parse_correct_toc()
    print(f"\n✅ 正确目录项数: {len(correct_toc)}")
    print("\n前10项：")
    for i, item in enumerate(correct_toc[:10], 1):
        print(f"  [{i}] {item['number']:15} {item['title']}")
    
    # 2. 读取当前解析结果
    pdf_path = "/app/uploads/archive/2025/12/reference/2025-12-10_未命名项目_合同文件.pdf"
    engine = ParseEngine()
    result = engine.parse(pdf_path, "reference", save_to_db=False)
    parsed_chapters = result.get('chapters', [])
    
    print(f"\n❌ 当前解析结果数: {len(parsed_chapters)}")
    print("\n前10项：")
    for i, ch in enumerate(parsed_chapters[:10], 1):
        print(f"  [{i}] {ch.get('chapter_number', 'N/A'):15} {ch.get('chapter_title', 'N/A')}")
    
    # 3. 匹配度验证
    print(f"\n\n{'='*80}")
    print("匹配度分析")
    print("=" * 80)
    
    matched = 0
    parsed_dict = {ch['chapter_number']: ch for ch in parsed_chapters}
    
    for item in correct_toc:
        number = item['number']
        title = item['title']
        
        if number in parsed_dict:
            parsed_title = parsed_dict[number].get('chapter_title', '')
            if title in parsed_title or parsed_title in title:
                matched += 1
                status = "✅"
            else:
                status = "⚠️ "
        else:
            status = "❌"
        
        print(f"{status} {number:15} | 期望: {title:40} | 实际: {parsed_dict.get(number, {}).get('chapter_title', '未找到')[:40]}")
    
    print(f"\n匹配率: {matched}/{len(correct_toc)} ({matched/len(correct_toc)*100:.1f}%)")
    print(f"预期章节数: {len(correct_toc)}")
    print(f"实际章节数: {len(parsed_chapters)}")
    print(f"差异: {len(parsed_chapters) - len(correct_toc)} (正数=多了，负数=少了)")

if __name__ == '__main__':
    validate_parsing()
