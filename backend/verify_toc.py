#!/usr/bin/env python3
"""
é€è¡ŒéªŒè¯PDFç›®å½•ä¸è§£æç»“æœçš„å¯¹åº”å…³ç³»
"""

import psycopg2
from typing import List, Dict
import re

# PDFåŸå§‹ç›®å½•
PDF_TOC = """
ç¬¬ä¸€éƒ¨åˆ†åˆåŒåè®®ä¹¦...............................................................1
ä¸€ã€å·¥ç¨‹æ¦‚å†µ..................................................................1
äºŒã€åˆåŒå·¥æœŸ..................................................................1
ä¸‰ã€è´¨é‡æ ‡å‡†..................................................................2
å››ã€ç­¾çº¦åˆåŒä»·ä¸åˆåŒä»·æ ¼å½¢å¼..................................................2
äº”ã€é¡¹ç›®ç»ç†..................................................................2
å…­ã€åˆåŒæ–‡ä»¶æ„æˆ..............................................................2
ä¸ƒã€æ‰¿è¯º......................................................................3
å…«ã€è¯è¯­å«ä¹‰..................................................................3
ä¹ã€ç­¾è®¢æ—¶é—´..................................................................3
åã€ç­¾è®¢åœ°ç‚¹..................................................................3
åä¸€ã€è¡¥å……åè®®................................................................3
åäºŒã€åˆåŒç”Ÿæ•ˆ................................................................3
åä¸‰ã€åˆåŒä»½æ•°................................................................3
ç¬¬äºŒéƒ¨åˆ†é€šç”¨åˆåŒæ¡æ¬¾.............................................................5
1.ä¸€èˆ¬çº¦å®š...................................................................5
2.å‘åŒ…äºº....................................................................11
3.æ‰¿åŒ…äºº....................................................................13
4.ç›‘ç†äºº....................................................................16
5.å·¥ç¨‹è´¨é‡..................................................................18
6.å®‰å…¨æ–‡æ˜æ–½å·¥ä¸ç¯å¢ƒä¿æŠ¤....................................................19
7.å·¥æœŸå’Œè¿›åº¦................................................................22
8.ææ–™ä¸è®¾å¤‡................................................................26
9.è¯•éªŒä¸æ£€éªŒ................................................................29
10.å˜æ›´.....................................................................30
11.ä»·æ ¼è°ƒæ•´.................................................................34
12.åˆåŒä»·æ ¼ã€è®¡é‡ä¸æ”¯ä»˜.....................................................36
13.éªŒæ”¶å’Œå·¥ç¨‹è¯•è½¦...........................................................39
14.ç«£å·¥ç»“ç®—.................................................................43
15.ç¼ºé™·è´£ä»»ä¸ä¿ä¿®...........................................................44
16.è¿çº¦.....................................................................47
17.ä¸å¯æŠ—åŠ›.................................................................49
18.ä¿é™©.....................................................................51
19.ç´¢èµ”.....................................................................52
20.äº‰è®®è§£å†³.................................................................53
ç¬¬ä¸‰éƒ¨åˆ†ä¸“ç”¨åˆåŒæ¡æ¬¾............................................................55
1.ä¸€èˆ¬çº¦å®š..................................................................55
2.å‘åŒ…äºº....................................................................58
3.æ‰¿åŒ…äºº....................................................................58
4.ç›‘ç†äºº....................................................................60
5.å·¥ç¨‹è´¨é‡..................................................................61
6.å®‰å…¨æ–‡æ˜æ–½å·¥ä¸ç¯å¢ƒä¿æŠ¤....................................................61
7.å·¥æœŸå’Œè¿›åº¦................................................................62
8.ææ–™ä¸è®¾å¤‡................................................................63
9.è¯•éªŒä¸æ£€éªŒ................................................................64
10.å˜æ›´.....................................................................64
11.ä»·æ ¼è°ƒæ•´.................................................................65
12.åˆåŒä»·æ ¼ã€è®¡é‡ä¸æ”¯ä»˜.....................................................66
13.éªŒæ”¶å’Œå·¥ç¨‹è¯•è½¦...........................................................69
14.ç«£å·¥ç»“ç®—.................................................................70
15.ç¼ºé™·è´£ä»»æœŸä¸ä¿ä¿®.........................................................71
16.è¿çº¦.....................................................................72
17.ä¸å¯æŠ—åŠ›.................................................................73
18.ä¿é™©.....................................................................74
20.äº‰è®®è§£å†³.................................................................74
21.ç”²ä¹™åŒæ–¹çš„æƒåˆ©å’Œä¹‰åŠ¡......................................................74
é™„ä»¶1ï¼šæ‰¿åŒ…äººæ‰¿æ½å·¥ç¨‹é¡¹ç›®ä¸€è§ˆè¡¨..................................................79
é™„ä»¶2ï¼šå‘åŒ…äººä¾›åº”ææ–™è®¾å¤‡ä¸€è§ˆè¡¨..................................................80
é™„ä»¶3ï¼šå·¥ç¨‹è´¨é‡ä¿ä¿®ä¹¦............................................................81
é™„ä»¶4ï¼šä¸»è¦å»ºè®¾å·¥ç¨‹æ–‡ä»¶ç›®å½•......................................................83
é™„ä»¶5ï¼šæ‰¿åŒ…äººç”¨äºæœ¬å·¥ç¨‹æ–½å·¥çš„æœºæ¢°è®¾å¤‡è¡¨..........................................84
é™„ä»¶6ï¼šæ‰¿åŒ…äººä¸»è¦æ–½å·¥ç®¡ç†äººå‘˜è¡¨..................................................85
é™„ä»¶7ï¼šåˆ†åŒ…äººä¸»è¦æ–½å·¥ç®¡ç†äººå‘˜è¡¨..................................................86
é™„ä»¶8ï¼šå±¥çº¦æ‹…ä¿..................................................................87
é™„ä»¶9ï¼šé¢„ä»˜æ¬¾æ‹…ä¿...............................................................88
é™„ä»¶10:æ”¯ä»˜æ‹…ä¿................................................................89
é™„ä»¶11ï¼š.........................................................................92
11-1ï¼šææ–™æš‚ä¼°ä»·è¡¨...........................................................92
11-2ï¼šå·¥ç¨‹è®¾å¤‡æš‚ä¼°ä»·è¡¨.......................................................92
11-3ï¼šä¸“ä¸šå·¥ç¨‹æš‚ä¼°ä»·è¡¨.......................................................94
12ï¼šå·¥ç¨‹æ¬¾æ”¯ä»˜ç”³è¯·è¡¨.............................................................95
13ï¼šä»£ç†äººæˆæƒå§”æ‰˜ä¹¦.............................................................96
"""

def parse_toc_line(line: str) -> Dict:
    """è§£æPDFç›®å½•ä¸­çš„ä¸€è¡Œ"""
    # ç§»é™¤é¡µç 
    line = re.sub(r'\.+\d+$', '', line).strip()
    
    if not line:
        return None
    
    # åˆ¤æ–­å±‚çº§å’Œæå–å†…å®¹
    result = {
        'original': line,
        'level': 1,
        'number': '',
        'title': '',
        'type': 'unknown'
    }
    
    # ç¬¬Xéƒ¨åˆ† (ç¬¬ä¸€å±‚çº§)
    if line.startswith('ç¬¬') and 'éƒ¨åˆ†' in line:
        match = re.match(r'ç¬¬([ä¸€äºŒä¸‰])éƒ¨åˆ†(.+)', line)
        if match:
            result['level'] = 1
            result['number'] = match.group(1)
            result['title'] = match.group(2)
            result['type'] = 'part'
            return result
    
    # ä¸­æ–‡æ•°å­— (ä¸€ã€äºŒã€ä¸‰...) - ç¬¬äºŒå±‚çº§
    if re.match(r'^[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ã€', line):
        match = re.match(r'^([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)ã€(.+)', line)
        if match:
            result['level'] = 2
            result['number'] = match.group(1)
            result['title'] = match.group(2)
            result['type'] = 'chinese_number'
            return result
    
    # é˜¿æ‹‰ä¼¯æ•°å­— (1. 2. 3. ...) - ç¬¬äºŒ/ä¸‰å±‚çº§
    if re.match(r'^\d+\.', line):
        parts = line.split('.', 1)
        result['number'] = parts[0]
        result['title'] = parts[1].strip() if len(parts) > 1 else ''
        result['level'] = 2  # æš‚å®šä¸º2å±‚
        result['type'] = 'arabic_number'
        return result
    
    # é™„ä»¶ - ç‰¹æ®Šå±‚çº§
    if line.startswith('é™„ä»¶'):
        match = re.match(r'^é™„ä»¶(\d+)[ï¼š:](.+)', line)
        if match:
            result['level'] = 2
            result['number'] = f"é™„ä»¶{match.group(1)}"
            result['title'] = match.group(2)
            result['type'] = 'attachment'
            return result
    
    # é™„ä»¶å­é¡¹ (11-1, 11-2)
    if re.match(r'^\d+-\d+[ï¼š:]', line):
        match = re.match(r'^(\d+-\d+)[ï¼š:](.+)', line)
        if match:
            result['level'] = 3
            result['number'] = match.group(1)
            result['title'] = match.group(2)
            result['type'] = 'attachment_sub'
            return result
    
    # å•ç‹¬çš„æ•°å­—é¡¹ (12: 13:)
    if re.match(r'^\d+[ï¼š:]', line):
        match = re.match(r'^(\d+)[ï¼š:](.+)', line)
        if match:
            result['level'] = 2
            result['number'] = match.group(1)
            result['title'] = match.group(2)
            result['type'] = 'single_number'
            return result
    
    return None


def get_parsed_chapters():
    """ä»æ•°æ®åº“è·å–è§£æç»“æœ"""
    conn = psycopg2.connect(
        host='localhost',
        port=15432,
        database='bidding_db',
        user='postgres',
        password='BiddingSystem@2025'
    )
    
    cursor = conn.cursor()
    cursor.execute("""
        SELECT 
            c.chapter_number,
            c.chapter_title,
            c.chapter_level,
            c.position_order
        FROM chapters c
        JOIN files f ON c.file_id = f.id
        WHERE f.filename LIKE '%2017%' OR f.filename LIKE '%GF%'
        ORDER BY c.position_order
    """)
    
    chapters = []
    for row in cursor.fetchall():
        chapters.append({
            'number': row[0],
            'title': row[1],
            'level': row[2],
            'position': row[3]
        })
    
    cursor.close()
    conn.close()
    
    return chapters


def find_in_parsed(toc_item: Dict, parsed_chapters: List[Dict]) -> Dict:
    """åœ¨è§£æç»“æœä¸­æŸ¥æ‰¾å¯¹åº”é¡¹"""
    title = toc_item['title']
    
    # ç²¾ç¡®åŒ¹é…æ ‡é¢˜
    exact_matches = [ch for ch in parsed_chapters if ch['title'] == title]
    
    # æ¨¡ç³ŠåŒ¹é… (æ ‡é¢˜åŒ…å«)
    fuzzy_matches = [ch for ch in parsed_chapters if title in ch['title'] or ch['title'] in title]
    
    return {
        'exact': exact_matches,
        'fuzzy': fuzzy_matches
    }


def main():
    print("=" * 100)
    print("PDFç›®å½•ä¸è§£æç»“æœé€è¡ŒéªŒè¯")
    print("=" * 100)
    print()
    
    # è§£æPDFç›®å½•
    toc_lines = [line.strip() for line in PDF_TOC.strip().split('\n') if line.strip()]
    toc_items = []
    
    for line in toc_lines:
        item = parse_toc_line(line)
        if item:
            toc_items.append(item)
    
    # è·å–è§£æç»“æœ
    parsed_chapters = get_parsed_chapters()
    
    print(f"ğŸ“‹ PDFç›®å½•æ€»è¡Œæ•°: {len(toc_items)}")
    print(f"ğŸ“‹ è§£æç»“æœæ€»æ•°: {len(parsed_chapters)}")
    print()
    
    # é€è¡ŒéªŒè¯
    success_count = 0
    fail_count = 0
    
    for idx, toc_item in enumerate(toc_items, 1):
        print(f"\nã€ç¬¬{idx}è¡Œã€‘åŸæ–‡: {toc_item['original']}")
        print(f"  è§£æ: å±‚çº§={toc_item['level']}, ç¼–å·={toc_item['number']}, æ ‡é¢˜={toc_item['title']}, ç±»å‹={toc_item['type']}")
        
        # åœ¨è§£æç»“æœä¸­æŸ¥æ‰¾
        matches = find_in_parsed(toc_item, parsed_chapters)
        
        if matches['exact']:
            print(f"  âœ… æ‰¾åˆ°ç²¾ç¡®åŒ¹é…:")
            for match in matches['exact'][:3]:
                print(f"     - [{match['level']}å±‚] {match['number']} {match['title']}")
            success_count += 1
        elif matches['fuzzy']:
            print(f"  âš ï¸  æ‰¾åˆ°æ¨¡ç³ŠåŒ¹é…:")
            for match in matches['fuzzy'][:3]:
                print(f"     - [{match['level']}å±‚] {match['number']} {match['title']}")
            success_count += 1
        else:
            print(f"  âŒ æœªæ‰¾åˆ°åŒ¹é…")
            print(f"  ğŸ’¡ åˆ†æ: å¯èƒ½æ˜¯ç»“æ„æ€§æ ‡é¢˜(å¦‚'ç¬¬Xéƒ¨åˆ†')æˆ–é™„ä»¶é¡¹æœªè§£æ")
            fail_count += 1
    
    # æ€»ç»“
    print("\n" + "=" * 100)
    print("éªŒè¯æ€»ç»“")
    print("=" * 100)
    print(f"âœ… æˆåŠŸåŒ¹é…: {success_count}/{len(toc_items)} ({success_count/len(toc_items)*100:.1f}%)")
    print(f"âŒ æœªåŒ¹é…: {fail_count}/{len(toc_items)} ({fail_count/len(toc_items)*100:.1f}%)")
    print()
    
    # åˆ†ææœªåŒ¹é…çš„ç±»å‹
    unmatched_types = {}
    for toc_item in toc_items:
        matches = find_in_parsed(toc_item, parsed_chapters)
        if not matches['exact'] and not matches['fuzzy']:
            ttype = toc_item['type']
            unmatched_types[ttype] = unmatched_types.get(ttype, 0) + 1
    
    if unmatched_types:
        print("æœªåŒ¹é…é¡¹çš„ç±»å‹åˆ†å¸ƒ:")
        for ttype, count in sorted(unmatched_types.items(), key=lambda x: -x[1]):
            print(f"  - {ttype}: {count} ä¸ª")


if __name__ == '__main__':
    main()
