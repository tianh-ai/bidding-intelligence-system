## 文件目录索引建立逻辑分析

### 当前解析流程

#### 1. **文本提取阶段**
```
PDF文件
  ↓
pdfplumber + pypdf
  ↓
提取原始文本（含格式问题）
```

**存在的问题**：
- PDF提取出的文本包含大量空格字符
- 例如：`全 文` 而不是 `全文`
- 中文字符间被空格分隔

#### 2. **章节识别阶段**
```
原始文本行
  ↓
正则表达式匹配
  ├─ 第一章 标题
  ├─ 第一节 标题
  ├─ 1 标题
  ├─ 1.1 标题
  └─ 1.1.1 标题
  ↓
识别章节号、标题、级别
```

**当前正则模式**：
```python
self.chapter_patterns = [
    r'^第[一二三四五六七八九十百]+章\s+(.+)$',      # 第一章 标题
    r'^第[一二三四五六七八九十百]+节\s+(.+)$',      # 第一节 标题
    r'^(\d+)\s+(.+)$',                             # 1 标题
    r'^(\d+\.\d+)\s+(.+)$',                        # 1.1 标题
    r'^(\d+\.\d+\.\d+)\s+(.+)$',                   # 1.1.1 标题
]
```

**问题**：
- 正则表达式中的 `\s+` 只匹配单个空格
- 实际提取出的文本有多个空格
- 模式匹配不到某些格式的标题

#### 3. **章节内容分割阶段**
```
逐行处理文本
  ↓
If 是章节标题:
    ├─ 保存上一章节
    └─ 开始新章节
Else:
    └─ 累积到当前章节
  ↓
保存所有章节到数据库
```

**存在的问题**：
- 缺少的标题不会被识别为章节
- 导致某些内容被漏分
- 章节号和标题之间可能有多个空格

#### 4. **数据库存储阶段**
```
章节数据
  ↓
INSERT INTO chapters
  ├─ id: UUID
  ├─ file_id: 文件ID
  ├─ chapter_number: 1.1.1 (含空格错误)
  ├─ chapter_title: 标题 (含空格错误)
  ├─ chapter_level: 5
  ├─ position_order: 顺序
  └─ content: 章节内容
```

### 目前检测到的问题

#### 问题1：文本空格问题
- **表现**：`全 文` 变成 `全 文`
- **原因**：PDF提取时字符间被分隔
- **影响**：正则表达式无法正确匹配

#### 问题2：章节号和标题混淆
- **表现**：第一行是 `1.1.6 其 他`
- **应该是**：`1.1.6` 应该被识别为章节号
- **问题**：数字.数字.数字 格式的标题识别

#### 问题3：缺失的章节格式
- **表现**：410个章节中很多是全内容
- **原因**：有些文档结构不符合预期模式
- **影响**：无法正确分割

### 改进方案

#### 方案A：文本预处理优化
```python
def clean_text(text):
    # 1. 去除中文字符间的空格
    text = re.sub(r'([\u4e00-\u9fff])\s+([\u4e00-\u9fff])', r'\1\2', text)
    
    # 2. 合并多个空格为单个
    text = re.sub(r'\s+', ' ', text)
    
    # 3. 去除行首行尾空格
    text = text.strip()
    
    return text
```

#### 方案B：更完善的章节识别
```python
def _is_chapter_title_v2(self, line: str) -> tuple:
    line = line.strip()
    
    # 第一层：清理中文字符间的空格
    line = re.sub(r'([\u4e00-\u9fff])\s+([\u4e00-\u9fff])', r'\1\2', line)
    
    # 第二层：使用更灵活的正则
    patterns = [
        (r'^第([一二三四五六七八九十百千万]+)章[\s　]*(.+)$', 1),
        (r'^第([一二三四五六七八九十百千万]+)节[\s　]*(.+)$', 1),
        (r'^(\d+)[\s　]+(.+)$', 2),
        (r'^(\d+\.\d+)[\s　]+(.+)$', 2),
        (r'^(\d+\.\d+\.\d+)[\s　]+(.+)$', 2),
        (r'^(\d+\.\d+\.\d+\.\d+)[\s　]+(.+)$', 2),
    ]
    
    for pattern, level in patterns:
        match = re.match(pattern, line)
        if match:
            return True, {
                'number': match.group(1),
                'title': match.group(2).strip(),
                'level': level
            }
    
    return False, None
```

#### 方案C：智能章节标题检测
```python
# 使用页面结构信息
# 使用字体大小差异
# 使用缩进信息
# 使用粗体等格式标记
```

### 推荐修复步骤

1. **立即修复**：清理文本中的中文字符间空格
2. **短期改进**：改进正则表达式和模式匹配
3. **长期方案**：集成OCR或使用AI模型进行结构理解

### 验证检查清单

- [ ] 检查PDF提取的原始文本
- [ ] 检查正则匹配是否成功
- [ ] 检查生成的章节数据
- [ ] 验证章节标题的准确性
- [ ] 确认层级关系正确

---

**建议**：使用改进的文本清理方案，重新处理已上传的文件。
